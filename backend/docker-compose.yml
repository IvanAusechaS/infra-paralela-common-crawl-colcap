services:
  # =========== API GATEWAY (PUNTO DE ENTRADA) ===========
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8000:8000"
    environment:
      - DATA_SERVICE_URL=http://data-acquisition:8001
      - PROCESS_SERVICE_URL=http://text-processor:8002
      - CORRELATION_SERVICE_URL=http://correlation-service:8003
      - ENV=development
      - LOG_LEVEL=INFO
      - API_GATEWAY_HOST=0.0.0.0
      - API_GATEWAY_PORT=8000
      - HTTP_TIMEOUT=30
      - CONNECT_TIMEOUT=5
      - READ_TIMEOUT=25
    volumes:
      - ./api-gateway:/app
    command: uvicorn app:app --host 0.0.0.0 --port 8000 --reload
    depends_on:
      - data-acquisition
      - text-processor
      - correlation-service
      - redis
      - postgres
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # =========== DATA ACQUISITION ===========
  data-acquisition:
    build: ./data-acquisition
    container_name: data-acquisition
    ports:
      - "8001:8001"
    environment:
      - ENV=development
      - USE_MOCK_MODE=true
      - AWS_ACCESS_KEY_ID=none
      - AWS_SECRET_ACCESS_KEY=none
      - AWS_DEFAULT_REGION=us-east-1
      - COMMON_CRAWL_MODE=auto
      - COMMON_CRAWL_BUCKET=commoncrawl
      - MAX_RECORDS_PER_FILE=20
      - MAX_WARC_FILES=3
      - MAX_TOTAL_RECORDS=50
      - DATABASE_URL=postgresql://news2market:password@postgres/news2market
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
    volumes:
      - ./data-acquisition:/app
      - ./data:/app/data
    command: >
      sh -c "python -c 'from database import init_db; init_db()' &&
             uvicorn app:app --host 0.0.0.0 --port 8001 --reload"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # =========== TEXT PROCESSOR ===========
  text-processor:
    build: ./text-processor
    container_name: text-processor
    ports:
      - "8002:8002"
    env_file:
      - ./text-processor/.env
    volumes:
      - ./text-processor:/app
    command: uvicorn app:app --host 0.0.0.0 --port 8002 --reload
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # =========== CORRELATION SERVICE ===========
  correlation-service:
    build: ./correlation-service
    container_name: correlation-service
    ports:
      - "8003:8003"
    env_file:
      - ./correlation-service/.env
    volumes:
      - ./correlation-service:/app
    command: uvicorn app:app --host 0.0.0.0 --port 8003 --reload
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8003/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
  
  # =========== POSTGRESQL ===========
  postgres:
    image: postgres:15
    container_name: news2market-postgres
    environment:
      POSTGRES_DB: news2market
      POSTGRES_USER: news2market
      POSTGRES_PASSWORD: password
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U news2market -d news2market"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # =========== REDIS ===========
  redis:
    image: redis:7-alpine
    container_name: news2market-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
  
  # =========== PGADMIN ===========
  pgadmin:
    image: dpage/pgadmin4
    container_name: news2market-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@news2market.com
      PGADMIN_DEFAULT_PASSWORD: admin123
    ports:
      - "5050:80"
    depends_on:
      - postgres

volumes:
  postgres_data:
